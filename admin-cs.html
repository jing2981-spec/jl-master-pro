<!DOCTYPE html>
<html lang="zh">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>JL Master Pro Â· å®¢æœç®¡ç†åå°</title>
<style>
@import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;700&display=swap');
*{margin:0;padding:0;box-sizing:border-box;}
:root{--bg:#0A0C10;--s1:#12151C;--s2:#1A1E28;--bd:#2A2E3A;--or:#FF8C00;--green:#3DD47E;--red:#FF3B30;--txt:#E8E8E8;--dim:#888;}
body{background:var(--bg);color:var(--txt);font-family:'JetBrains Mono',monospace;min-height:100vh;}

/* â•â•â• LOGIN â•â•â• */
.login-screen{display:flex;align-items:center;justify-content:center;min-height:100vh;padding:20px;}
.login-box{background:var(--s1);border:1px solid var(--bd);border-radius:16px;padding:40px 32px;width:100%;max-width:380px;text-align:center;}
.login-box h2{color:var(--or);margin-bottom:24px;font-size:18px;}
.login-box input{width:100%;background:var(--s2);border:1px solid var(--bd);border-radius:10px;padding:12px 16px;
  color:#fff;font-size:14px;font-family:inherit;margin-bottom:12px;outline:none;}
.login-box input:focus{border-color:var(--or);}
.login-box button{width:100%;padding:12px;background:var(--or);color:#fff;border:none;border-radius:10px;
  font-size:14px;font-weight:700;cursor:pointer;font-family:inherit;transition:.2s;}
.login-box button:hover{opacity:.85;}
.login-box .err{color:var(--red);font-size:11px;margin-top:8px;min-height:16px;}

/* â•â•â• DASHBOARD â•â•â• */
.dashboard{display:none;height:100vh;overflow:hidden;}
.dash-header{display:flex;align-items:center;justify-content:space-between;padding:16px 24px;
  border-bottom:1px solid var(--bd);background:var(--s1);}
.dash-header h1{font-size:16px;color:var(--or);}
.dash-header .stats{font-size:11px;color:var(--dim);}
.dash-header button{background:var(--s2);border:1px solid var(--bd);color:var(--dim);padding:6px 14px;
  border-radius:8px;cursor:pointer;font-family:inherit;font-size:11px;transition:.2s;}
.dash-header button:hover{color:#fff;border-color:var(--or);}

.dash-body{display:flex;height:calc(100vh - 57px);overflow:hidden;}

/* User list */
.user-list{width:280px;min-width:220px;border-right:1px solid var(--bd);overflow-y:auto;background:var(--s1);flex-shrink:0;}
.user-item{display:flex;align-items:center;gap:10px;padding:14px 16px;cursor:pointer;transition:.15s;border-bottom:1px solid rgba(255,255,255,.04);}
.user-item:hover{background:rgba(255,140,0,.06);}
.user-item.active{background:rgba(255,140,0,.12);border-left:3px solid var(--or);}
.user-item .avatar{width:36px;height:36px;border-radius:50%;background:var(--s2);border:1px solid var(--bd);
  display:flex;align-items:center;justify-content:center;font-size:14px;flex-shrink:0;}
.user-item .info{flex:1;min-width:0;}
.user-item .name{font-size:12px;font-weight:700;color:#fff;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
.user-item .preview{font-size:10px;color:var(--dim);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;margin-top:2px;}
.user-item .meta{text-align:right;flex-shrink:0;}
.user-item .time{font-size:9px;color:var(--dim);display:block;}
.user-item .unread{background:var(--red);color:#fff;font-size:9px;min-width:18px;height:18px;border-radius:9px;
  display:inline-flex;align-items:center;justify-content:center;font-weight:800;margin-top:4px;}
.user-item .unread.hide{display:none;}
.no-users{text-align:center;padding:40px 20px;color:var(--dim);font-size:12px;}

/* Chat panel */
.chat-panel{flex:1;display:flex;flex-direction:column;background:var(--bg);}
.chat-header{padding:14px 20px;border-bottom:1px solid var(--bd);background:var(--s1);
  display:flex;align-items:center;justify-content:space-between;}
.chat-header .chat-user{font-size:13px;font-weight:700;color:var(--or);}
.chat-header .chat-id{font-size:9px;color:var(--dim);margin-top:2px;}
.chat-empty{flex:1;display:flex;align-items:center;justify-content:center;color:var(--dim);font-size:13px;}

.chat-msgs{flex:1;overflow-y:auto;padding:16px 20px;display:flex;flex-direction:column;gap:8px;-webkit-overflow-scrolling:touch;}
.msg{max-width:75%;padding:10px 14px;border-radius:14px;font-size:12px;line-height:1.6;word-break:break-word;}
.msg.user-msg{align-self:flex-start;background:rgba(255,255,255,.08);color:var(--txt);border-bottom-left-radius:4px;}
.msg.admin-msg{align-self:flex-end;background:linear-gradient(135deg,var(--green),#2AAE66);color:#fff;border-bottom-right-radius:4px;}
.msg .msg-time{font-size:9px;color:rgba(255,255,255,.4);margin-top:4px;display:block;}
.msg.admin-msg .msg-time{color:rgba(255,255,255,.6);}

.chat-input{display:flex;gap:8px;padding:14px 18px;border-top:1px solid var(--bd);background:var(--s1);}
.chat-input textarea{flex:1;background:var(--s2);border:1px solid var(--bd);border-radius:10px;padding:10px 14px;
  color:#fff;font-size:12px;font-family:inherit;outline:none;resize:none;min-height:40px;max-height:100px;}
.chat-input textarea:focus{border-color:var(--green);}
.chat-input button{background:var(--green);color:#fff;border:none;border-radius:10px;padding:10px 20px;
  font-weight:700;font-size:12px;cursor:pointer;font-family:inherit;transition:.2s;white-space:nowrap;align-self:flex-end;}
.chat-input button:hover{opacity:.85;}
.chat-input button:disabled{opacity:.4;cursor:not-allowed;}

/* Mobile responsive */
@media(max-width:640px){
  .user-list{width:100%;border-right:none;}
  .chat-panel{display:none;}
  .dash-body.chatting .user-list{display:none;}
  .dash-body.chatting .chat-panel{display:flex;}
  .back-btn{display:inline-block !important;}
}
.back-btn{display:none;background:none;border:none;color:var(--or);cursor:pointer;font-size:14px;font-family:inherit;padding:4px 8px;}
</style>
</head>
<body>

<!-- LOGIN -->
<div class="login-screen" id="login-screen">
  <div class="login-box">
    <h2>ğŸ” JL Master Pro<br>å®¢æœç®¡ç†åå°</h2>
    <input type="text" id="admin-key" placeholder="è¾“å…¥ Service Role Key" autocomplete="off">
    <button onclick="doLogin()">ç™»å½•</button>
    <div class="err" id="login-err"></div>
    <p style="font-size:9px;color:var(--dim);margin-top:16px;line-height:1.6;">
      Service Role Key åœ¨ Supabase Dashboard â†’<br>Settings â†’ API â†’ service_role (secret)
    </p>
  </div>
</div>

<!-- DASHBOARD -->
<div class="dashboard" id="dashboard">
  <div class="dash-header">
    <div>
      <h1>ğŸ’¬ JL å®¢æœåå°</h1>
      <div class="stats" id="stats">åŠ è½½ä¸­...</div>
    </div>
    <div style="display:flex;gap:8px;">
      <button onclick="refreshAll()">ğŸ”„ åˆ·æ–°</button>
      <button onclick="doLogout()">é€€å‡º</button>
    </div>
  </div>
  <div class="dash-body" id="dash-body">
    <div class="user-list" id="user-list">
      <div class="no-users" id="no-users">åŠ è½½ä¸­...</div>
    </div>
    <div class="chat-panel" id="chat-panel">
      <div class="chat-empty" id="chat-empty">â† é€‰æ‹©ä¸€ä¸ªç”¨æˆ·æŸ¥çœ‹å¯¹è¯</div>
      <div class="chat-header" id="chat-header" style="display:none;">
        <div>
          <button class="back-btn" onclick="backToList()">â† è¿”å›</button>
          <span class="chat-user" id="chat-user-name"></span>
          <div class="chat-id" id="chat-user-id"></div>
        </div>
      </div>
      <div class="chat-msgs" id="chat-msgs" style="display:none;"></div>
      <div class="chat-input" id="chat-input" style="display:none;">
        <textarea id="reply-input" placeholder="è¾“å…¥å›å¤..." rows="1"
                  onkeydown="if(event.key==='Enter'&&!event.shiftKey){event.preventDefault();sendReply();}"></textarea>
        <button onclick="sendReply()" id="reply-btn">å‘é€å›å¤</button>
      </div>
    </div>
  </div>
</div>

<script>
var SB_URL='https://tglnvswsdbydxljqzmwr.supabase.co';
var SB_KEY=''; /* service_role key - entered at login */
var ANON_KEY='eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRnbG52c3dzZGJ5ZHhsanF6bXdyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIwODQ3ODcsImV4cCI6MjA4NzY2MDc4N30.jZbAZAR0rHA0KpjyA8jSnf0bK7Id5U9cDvIqr_tdqmU';

var allMessages=[];
var userMap={};  /* uid -> {email, messages[], unread} */
var activeUser=null;
var pollTimer=null;

function $i(id){return document.getElementById(id);}

/* â•â•â• AUTH â•â•â• */
function doLogin(){
  var key=$i('admin-key').value.trim();
  if(!key||key.length<50){$i('login-err').textContent='è¯·è¾“å…¥æœ‰æ•ˆçš„ Service Role Key';return;}
  $i('login-err').textContent='éªŒè¯ä¸­...';
  SB_KEY=key;
  /* Test key by fetching messages */
  sbAdmin('/rest/v1/cs_messages?select=id&limit=1','GET').then(function(r){
    if(!r.ok)throw new Error('Invalid key');
    return r.json();
  }).then(function(){
    $i('login-err').textContent='';
    try{sessionStorage.setItem('jl_admin_key',key);}catch(e){}
    showDashboard();
  }).catch(function(e){
    $i('login-err').textContent='Key æ— æ•ˆæˆ–æ— æ³•è¿æ¥ Supabase';
    SB_KEY='';
  });
}

function doLogout(){
  SB_KEY='';
  try{sessionStorage.removeItem('jl_admin_key');}catch(e){}
  if(pollTimer)clearInterval(pollTimer);
  $i('dashboard').style.display='none';
  $i('login-screen').style.display='flex';
}

function sbAdmin(path,method,body){
  var h={'Content-Type':'application/json','apikey':SB_KEY,'Authorization':'Bearer '+SB_KEY};
  var opts={method:method||'GET',headers:h};
  if(body)opts.body=JSON.stringify(body);
  return fetch(SB_URL+path,opts);
}

/* â•â•â• DASHBOARD â•â•â• */
function showDashboard(){
  $i('login-screen').style.display='none';
  $i('dashboard').style.display='block';
  refreshAll();
  if(pollTimer)clearInterval(pollTimer);
  pollTimer=setInterval(refreshAll,15000); /* auto-refresh every 15s */
}

function refreshAll(){
  /* Fetch all messages */
  sbAdmin('/rest/v1/cs_messages?order=created_at.asc&select=*','GET')
  .then(function(r){return r.json();})
  .then(function(data){
    if(!Array.isArray(data)){console.error('Bad data',data);return;}
    allMessages=data;
    /* Fetch user emails */
    var uids=[...new Set(data.map(function(m){return m.user_id;}))];
    if(uids.length===0){
      userMap={};
      renderUserList();
      return;
    }
    /* Get user info from auth.users via admin API */
    return sbAdmin('/auth/v1/admin/users?per_page=1000','GET')
    .then(function(r){return r.json();})
    .then(function(authData){
      var users=(authData&&authData.users)||[];
      var emailMap={};
      users.forEach(function(u){emailMap[u.id]=u.email||u.id.slice(0,8);});
      buildUserMap(emailMap);
    }).catch(function(){
      /* If auth API fails, use UIDs as names */
      var emailMap={};
      uids.forEach(function(uid){emailMap[uid]=uid.slice(0,8)+'...';});
      buildUserMap(emailMap);
    });
  }).catch(function(e){
    $i('no-users').textContent='åŠ è½½å¤±è´¥: '+e.message;
  });
}

function buildUserMap(emailMap){
  userMap={};
  allMessages.forEach(function(m){
    if(!userMap[m.user_id]){
      userMap[m.user_id]={
        email:emailMap[m.user_id]||m.user_id.slice(0,8),
        messages:[],
        unread:0,
        lastTime:m.created_at
      };
    }
    userMap[m.user_id].messages.push(m);
    if(m.role==='user'&&!m.read)userMap[m.user_id].unread++;
    userMap[m.user_id].lastTime=m.created_at;
  });
  renderUserList();
  /* Update stats */
  var totalUsers=Object.keys(userMap).length;
  var totalUnread=Object.values(userMap).reduce(function(s,u){return s+u.unread;},0);
  $i('stats').textContent=totalUsers+' ä¸ªç”¨æˆ· Â· '+allMessages.length+' æ¡æ¶ˆæ¯'+(totalUnread>0?' Â· '+totalUnread+' æœªè¯»':'');
  /* Re-render active chat if open */
  if(activeUser&&userMap[activeUser]){
    renderChat(activeUser);
  }
}

function renderUserList(){
  var list=$i('user-list');
  var noUsers=$i('no-users');
  var keys=Object.keys(userMap);
  if(keys.length===0){
    list.innerHTML='';
    noUsers.textContent='æš‚æ— ç”¨æˆ·æ¶ˆæ¯';
    list.appendChild(noUsers);
    return;
  }
  /* Sort: unread first, then by last message time */
  keys.sort(function(a,b){
    var ua=userMap[a],ub=userMap[b];
    if(ua.unread>0&&ub.unread===0)return -1;
    if(ua.unread===0&&ub.unread>0)return 1;
    return new Date(ub.lastTime)-new Date(ua.lastTime);
  });
  list.innerHTML='';
  keys.forEach(function(uid){
    var u=userMap[uid];
    var last=u.messages[u.messages.length-1];
    var div=document.createElement('div');
    div.className='user-item'+(activeUser===uid?' active':'');
    div.onclick=function(){selectUser(uid);};
    div.innerHTML=
      '<div class="avatar">'+(u.unread>0?'ğŸ””':'ğŸ‘¤')+'</div>'+
      '<div class="info">'+
        '<div class="name">'+escHtml(u.email)+'</div>'+
        '<div class="preview">'+(last?escHtml(last.body.slice(0,40)):'')+'</div>'+
      '</div>'+
      '<div class="meta">'+
        '<span class="time">'+fmtTime(u.lastTime)+'</span>'+
        (u.unread>0?'<span class="unread">'+u.unread+'</span>':'')+
      '</div>';
    list.appendChild(div);
  });
}

function selectUser(uid){
  activeUser=uid;
  renderUserList();
  renderChat(uid);
  /* Mobile: switch to chat view */
  $i('dash-body').classList.add('chatting');
}

function backToList(){
  $i('dash-body').classList.remove('chatting');
  activeUser=null;
  renderUserList();
}

function renderChat(uid){
  var u=userMap[uid];
  if(!u)return;
  $i('chat-empty').style.display='none';
  $i('chat-header').style.display='flex';
  $i('chat-msgs').style.display='flex';
  $i('chat-input').style.display='flex';
  $i('chat-user-name').textContent=u.email;
  $i('chat-user-id').textContent='UID: '+uid;
  var container=$i('chat-msgs');
  container.innerHTML='';
  u.messages.forEach(function(m){
    var div=document.createElement('div');
    div.className='msg '+(m.role==='admin'?'admin-msg':'user-msg');
    div.innerHTML='<span>'+escHtml(m.body)+'</span><span class="msg-time">'+fmtTimeFull(m.created_at)+
      (m.role==='admin'?' Â· å®¢æœ':'')+'</span>';
    container.appendChild(div);
  });
  container.scrollTop=container.scrollHeight;
  $i('reply-input').focus();
  /* Mark user messages as read */
  markUserMsgsRead(uid);
}

function sendReply(){
  if(!activeUser)return;
  var inp=$i('reply-input');
  var body=inp.value.trim();
  if(!body)return;
  inp.value='';
  $i('reply-btn').disabled=true;
  var msg={
    id:'admin-'+Date.now().toString(36)+Math.random().toString(36).slice(2,5),
    user_id:activeUser,
    role:'admin',
    body:body,
    read:false,
    created_at:new Date().toISOString()
  };
  sbAdmin('/rest/v1/cs_messages','POST',msg)
  .then(function(r){
    if(!r.ok)throw new Error('Send failed');
    $i('reply-btn').disabled=false;
    refreshAll();
  }).catch(function(e){
    alert('å‘é€å¤±è´¥: '+e.message);
    $i('reply-btn').disabled=false;
  });
}

function markUserMsgsRead(uid){
  var u=userMap[uid];
  if(!u||u.unread===0)return;
  /* Update all unread user messages for this user */
  sbAdmin('/rest/v1/cs_messages?user_id=eq.'+uid+'&role=eq.user&read=eq.false','PATCH',{read:true})
  .then(function(){
    u.unread=0;
    u.messages.forEach(function(m){if(m.role==='user')m.read=true;});
    renderUserList();
  }).catch(function(){});
}

/* â•â•â• HELPERS â•â•â• */
function escHtml(s){
  var d=document.createElement('div');d.textContent=s||'';return d.innerHTML;
}
function pad(n){return n<10?'0'+n:''+n;}
function fmtTime(iso){
  try{
    var d=new Date(iso);var now=new Date();
    var diff=now-d;
    if(diff<60000)return 'åˆšåˆš';
    if(diff<3600000)return Math.floor(diff/60000)+'åˆ†é’Ÿå‰';
    if(diff<86400000)return pad(d.getHours())+':'+pad(d.getMinutes());
    return pad(d.getMonth()+1)+'/'+pad(d.getDate());
  }catch(e){return '';}
}
function fmtTimeFull(iso){
  try{
    var d=new Date(iso);
    return d.getFullYear()+'/'+pad(d.getMonth()+1)+'/'+pad(d.getDate())+' '+pad(d.getHours())+':'+pad(d.getMinutes());
  }catch(e){return '';}
}

/* â•â•â• AUTO-LOGIN â•â•â• */
(function(){
  try{
    var k=sessionStorage.getItem('jl_admin_key');
    if(k&&k.length>50){SB_KEY=k;showDashboard();}
  }catch(e){}
})();
</script>
</body>
</html>
